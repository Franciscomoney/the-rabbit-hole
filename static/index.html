<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Rabbit Hole | Interactive Audio Adventures</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <style>
        /* ========== VARIABLES ========== */
        :root {
            --primary: #a3ffac;
            --bg-deep: #050a07;
            --bg-card: #0f1c15;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --glass-bg: rgba(15, 28, 21, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-light: rgba(255, 255, 255, 0.05);
            --nvidia-green: #a3ffac;
            --accent: #a3ffac;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #020504;
            color: var(--text-main);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app {
            width: 100%;
            max-width: 430px;
            height: 100vh;
            height: 100dvh;
            background: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, #1a3a2a 0%, #050a07 60%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        @media (min-width: 431px) {
            body { padding: 20px; }
            .app {
                height: 92vh;
                max-height: 900px;
                border-radius: 40px;
                box-shadow: 0 25px 80px rgba(0,0,0,0.6);
                border: 1px solid var(--glass-border);
            }
        }

        .screen { display: none; flex-direction: column; flex: 1; overflow: hidden; }
        .screen.active { display: flex; }

        /* ========== HOME / LIBRARY SCREEN ========== */
        .home {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .home-header {
            padding: 24px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-logo {
            font-family: 'Merriweather', serif;
            font-weight: 900;
            font-size: 1.8rem;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .brand-tagline {
            font-size: 0.85rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 0 20px;
            margin-top: 4px;
            margin-bottom: 8px;
        }

        .nvidia-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--nvidia-green);
            letter-spacing: 0.3px;
            border: 1px solid rgba(163, 255, 172, 0.3);
            padding: 4px 10px;
            border-radius: 12px;
        }
        .nvidia-badge svg { width: 14px; height: 14px; flex-shrink: 0; }
        .nvidia-badge span { color: var(--text-muted); font-weight: 400; }

        /* Filter pills */
        .filter-tabs {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .filter-tabs::-webkit-scrollbar { display: none; }

        .filter-tab {
            padding: 8px 20px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-light);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-muted);
            font-family: inherit;
            transition: all 0.2s;
        }
        .filter-tab.active {
            background: var(--primary);
            color: var(--bg-deep);
            font-weight: 600;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(163, 255, 172, 0.2);
        }

        /* Scrollable area */
        .home-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        /* Section headers */
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px 10px;
        }
        .section-label {
            font-family: 'Merriweather', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }
        .section-count {
            font-size: 0.78rem;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 8px;
        }

        /* Book grid - 2 columns */
        .book-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 0 20px;
        }

        .search-toggle-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.06);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .search-toggle-btn:active { transform: scale(0.9); }
        .search-toggle-btn.active { color: var(--primary); border-color: var(--primary); background: rgba(163,255,172,0.1); }

        /* Search bar */
        .search-bar {
            display: none;
            align-items: center;
            margin: 0 20px 10px;
            padding: 0 14px;
            height: 42px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            gap: 10px;
            transition: border-color 0.2s;
        }
        .search-bar.active { display: flex; }
        .search-bar:focus-within { border-color: var(--primary); }

        .search-bar-icon { color: var(--text-muted); flex-shrink: 0; }

        .search-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 0.88rem;
            font-family: inherit;
            outline: none;
        }
        .search-input::placeholder { color: var(--text-muted); }

        .search-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 2px;
            display: none;
        }
        .search-clear.visible { display: block; }

        .book-cell {
            cursor: pointer;
            background: var(--glass-light);
            border-radius: 16px;
            padding: 12px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .book-cell:active {
            border-color: var(--glass-border);
            background: rgba(255,255,255,0.08);
            transform: scale(0.97);
        }

        .book-cover {
            width: 100%;
            aspect-ratio: 2 / 3;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }

        .book-cover-inner {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 10px;
            text-align: center;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .book-cover-title {
            font-family: 'Merriweather', serif;
            font-size: 0.78rem;
            font-weight: 700;
            color: white;
            line-height: 1.3;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
            word-break: break-word;
        }

        .book-cover-author {
            font-size: 0.58rem;
            font-weight: 500;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .book-name {
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--text-main);
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .book-author {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Book list rows - primary view */
        .book-list { padding: 0 16px; }

        .book-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
        }
        .book-row:last-child { border: none; }

        .book-row-cover {
            width: 50px;
            height: 68px;
            border-radius: 8px;
            flex-shrink: 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .book-row-cover-inner {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            position: relative;
        }

        .book-row-cover-inner span {
            font-family: 'Merriweather', serif;
            font-size: 0.5rem;
            font-weight: 700;
            color: white;
            text-align: center;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .book-row-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .book-row-info { flex: 1; min-width: 0; }

        .book-row-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 3px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .book-row-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .book-row-stats {
            display: flex;
            gap: 10px;
            margin-top: 3px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 60px 30px;
        }
        .empty-icon { font-size: 3rem; margin-bottom: 14px; opacity: 0.4; }
        .empty-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* ========== UPLOAD SCREEN ========== */
        .upload-screen-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            position: relative;
            overflow-y: auto;
            padding-bottom: 100px;
        }

        .upload-header {
            padding: 24px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Drop zone visual */
        .upload-drop-zone {
            margin: 0 20px 24px;
            height: 160px;
            border: 2px dashed rgba(163, 255, 172, 0.3);
            border-radius: 24px;
            background: rgba(15, 28, 21, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-drop-zone:hover, .upload-drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(163, 255, 172, 0.05);
            box-shadow: 0 0 30px rgba(163, 255, 172, 0.1);
        }
        .upload-drop-zone.has-file {
            border-color: var(--primary);
            border-style: solid;
            background: rgba(163, 255, 172, 0.08);
        }
        .upload-drop-zone.has-file .upload-drop-icon { background: rgba(163, 255, 172, 0.15); border-color: rgba(163, 255, 172, 0.3); }
        .upload-drop-zone.has-file .upload-drop-icon svg { color: var(--primary); }

        .upload-drop-icon {
            width: 70px;
            height: 70px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .upload-drop-icon svg {
            color: var(--primary);
            width: 28px;
            height: 28px;
        }

        .upload-drop-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .upload-drop-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            max-width: 200px;
            line-height: 1.5;
        }

        /* Steps section */
        .upload-steps {
            padding: 0 24px;
            margin-bottom: 30px;
        }

        .upload-steps-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .upload-step {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 18px;
        }

        .upload-step-num {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: rgba(163, 255, 172, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--primary);
            flex-shrink: 0;
        }

        .upload-step-text { flex: 1; padding-top: 4px; }
        .upload-step-text strong {
            display: block;
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 2px;
        }
        .upload-step-text span {
            font-size: 0.76rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Upload main button */
        .upload-main-btn {
            width: calc(100% - 48px);
            margin: 0 auto 30px;
            padding: 18px;
            border: none;
            border-radius: 16px;
            background: var(--primary);
            color: var(--bg-deep);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 0 30px rgba(163, 255, 172, 0.3);
            transition: transform 0.15s;
        }
        .upload-main-btn:active { transform: scale(0.97); }
        .upload-main-btn:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; }
        .upload-main-btn:disabled:active { transform: none; }
        .upload-main-btn svg { width: 20px; height: 20px; }

        .upload-formats {
            margin-top: 10px;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Upload overlay */
        .upload-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(5, 10, 7, 0.97);
            backdrop-filter: blur(20px);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0;
        }
        .upload-overlay.active { display: flex; }

        /* Scanner animation (upload) */
        .scanner-stage {
            position: relative;
            width: 180px;
            height: 270px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
        }

        .scanner-book {
            width: 130px;
            height: 195px;
            background: linear-gradient(135deg, #1a3a2a, #0f1c15);
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
            overflow: hidden;
            border: 1px solid rgba(163, 255, 172, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-book-icon {
            font-size: 2.5rem;
            opacity: 0.3;
        }

        .scanner-laser {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary);
            box-shadow: 0 0 20px 2px var(--primary);
            animation: scanLaser 2.5s ease-in-out infinite;
            z-index: 5;
        }

        @keyframes scanLaser {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .radar-ring {
            position: absolute;
            border: 1px solid var(--primary);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            z-index: 1;
        }

        .ring-1 { animation: ripple 3s linear infinite; }
        .ring-2 { animation: ripple 3s linear infinite; animation-delay: 1s; }
        .ring-3 { animation: ripple 3s linear infinite; animation-delay: 2s; }

        @keyframes ripple {
            0% { width: 80px; height: 80px; opacity: 0.6; border-width: 2px; }
            100% { width: 400px; height: 400px; opacity: 0; border-width: 0px; }
        }

        .upload-status-container { text-align: center; z-index: 10; }

        .upload-status-title {
            font-family: 'Merriweather', serif;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .upload-status {
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
        }
        .upload-status::after {
            content: '_';
            animation: blinkCursor 0.8s infinite;
        }

        @keyframes blinkCursor { 50% { opacity: 0; } }

        .upload-bar {
            width: 180px;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 16px;
        }

        .upload-bar-fill {
            height: 100%;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .file-input { display: none; }

        /* ========== BOOK DETAIL SCREEN ========== */
        .detail {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .detail-ambient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(circle at 50% 20%, #1a3a2a 0%, var(--bg-deep) 70%);
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            position: relative;
            z-index: 2;
        }

        .detail-back {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .detail-back:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        .detail-header-brand {
            font-family: 'Merriweather', serif;
            font-weight: 900;
            font-size: 1.15rem;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .detail-share-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .detail-share-btn:active { transform: scale(0.9); }

        .detail-actions { display: flex; gap: 8px; }

        .detail-btn-small {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .detail-btn-small:active { transform: scale(0.9); }

        .detail-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }

        .detail-cover-area {
            display: flex;
            justify-content: center;
            padding: 4px 20px 14px;
        }

        .detail-cover {
            width: 150px;
            aspect-ratio: 2 / 3;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 16px 40px rgba(0,0,0,0.6);
            position: relative;
        }

        .detail-cover-inner {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .detail-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .detail-cover-title {
            font-family: 'Merriweather', serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            line-height: 1.25;
            text-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .detail-cover-author {
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .detail-title {
            font-family: 'Merriweather', serif;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            padding: 0 20px;
            color: var(--text-main);
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .detail-author-name {
            font-size: 0.8rem;
            color: var(--primary);
            text-align: center;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            opacity: 0.9;
        }
        .detail-author-name svg { display: none; }

        .detail-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
        }

        .detail-play-btn {
            width: 100%;
            max-width: 340px;
            height: 50px;
            border-radius: 14px;
            background: var(--primary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--bg-deep);
            font-weight: 700;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 0 30px rgba(163, 255, 172, 0.25);
            transition: transform 0.2s;
        }
        .detail-play-btn:active { transform: scale(0.98); }
        .detail-play-btn svg { width: 22px; height: 22px; }

        /* Glass info sheet */
        .detail-info-sheet {
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.5));
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 18px 20px 14px;
            margin-top: 6px;
            flex: 1;
        }

        .detail-overview { margin-bottom: 10px; }

        .detail-overview-title {
            font-family: 'Merriweather', serif;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-main);
        }

        .detail-overview-text {
            font-size: 0.82rem;
            color: var(--text-muted);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding-top: 6px;
        }

        .detail-tag {
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            background: rgba(255,255,255,0.1);
        }

        .detail-bottom-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 10px 20px 8px;
            position: relative;
            z-index: 2;
        }

        .detail-bottom-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }
        .detail-bottom-btn:active { transform: scale(0.95); }
        .detail-bottom-btn.danger { color: #ff6b6b; border-color: rgba(255, 107, 107, 0.15); }

        /* ========== READER SCREEN ========== */
        #readerScreen {
            background: radial-gradient(circle at top right, #1a3a2a, #050a07);
        }

        .reader-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            position: relative;
        }

        .reader-back {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .reader-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Merriweather', serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            letter-spacing: 0.3px;
        }

        .reader-header-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        .reader-header-btn:active { background: rgba(255,255,255,0.1); }
        .reader-header-btn svg { width: 18px; height: 18px; }

        /* NVIDIA model bar */
        .model-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 0 20px 8px;
            font-size: 0.6rem;
            color: rgba(255,255,255,0.3);
        }
        .model-tag { display: flex; align-items: center; gap: 4px; }
        .model-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--primary); }
        .model-label { color: var(--primary); font-weight: 600; }

        /* Story area */
        .story-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 32px;
            position: relative;
            overflow: hidden;
        }

        .story-text-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 0%, black 8%, black 88%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 8%, black 88%, transparent 100%);
        }

        .story-text {
            position: absolute;
            width: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        .story-text .line {
            display: block;
            padding: 12px 0;
            font-family: 'Merriweather', serif;
            font-size: 1.15rem;
            font-weight: 400;
            line-height: 1.8;
            text-align: left;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left center;
        }

        .story-text .line.passed {
            opacity: 0.1;
            transform: scale(0.93);
            filter: blur(2px);
            color: rgba(255,255,255,0.3);
        }

        .story-text .line.current {
            opacity: 1;
            transform: scale(1);
            filter: blur(0);
            color: rgba(255,255,255,0.85);
        }

        .story-text .line.upcoming { color: rgba(255,255,255,0.4); }
        .story-text .line.upcoming-1 { opacity: 0.45; transform: scale(0.97); filter: blur(0.3px); }
        .story-text .line.upcoming-2 { opacity: 0.25; transform: scale(0.95); filter: blur(0.8px); }
        .story-text .line.upcoming-3 { opacity: 0.15; transform: scale(0.93); filter: blur(1.2px); }
        .story-text .line.upcoming-far { opacity: 0.06; transform: scale(0.91); filter: blur(1.8px); }

        /* Choice buttons - horizontal row inside player */
        .choices {
            display: flex;
            justify-content: center;
            gap: 14px;
            padding: 8px 0 4px;
        }

        .choice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .choice-btn:hover, .choice-btn:active {
            background: var(--primary);
            color: var(--bg-deep);
            border-color: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(163, 255, 172, 0.4);
        }
        .choice-btn:disabled { opacity: 0.25; cursor: not-allowed; }
        .choice-btn:disabled:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--glass-border);
            color: white;
            transform: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Player */
        .player { padding: 0 20px 20px; }

        .player-book {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            margin-bottom: 14px;
        }

        .player-book-cover {
            width: 42px;
            height: 56px;
            border-radius: 6px;
            flex-shrink: 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .player-book-cover-inner {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            position: relative;
        }

        .player-book-cover-inner span {
            font-family: 'Merriweather', serif;
            font-size: 0.45rem;
            font-weight: 700;
            color: white;
            text-align: center;
            line-height: 1.2;
        }

        .player-book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .player-book-info { flex: 1; min-width: 0; }
        .player-book-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-book-author {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
        }
        .player-chapter-info {
            text-align: right;
            font-size: 0.62rem;
            color: rgba(255,255,255,0.3);
            white-space: nowrap;
        }

        /* Progress */
        .progress-area { margin-bottom: 4px; }
        .progress {
            width: 100%;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 6px var(--primary);
        }
        .time-row { display: flex; justify-content: space-between; }
        .time-label { font-size: 0.65rem; color: rgba(255,255,255,0.35); font-weight: 500; }

        /* Transport controls */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            padding-top: 8px;
        }

        .ctrl-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ctrl-btn svg { width: 22px; height: 22px; }

        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(163, 255, 172, 0.3);
            transition: transform 0.15s;
        }
        .play-btn:hover { transform: scale(1.05); }
        .play-btn svg { width: 22px; height: 22px; }

        /* Loading overlay (neural weave) */
        .loading {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(5, 10, 7, 0.95);
            background-image: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.6) 100%);
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            gap: 0;
        }
        .loading.active { display: flex; }

        .weave-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        .weave-thread {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            box-shadow: 0 0 15px rgba(163, 255, 172, 0.2);
        }

        .weave-thread-1 {
            width: 100%; height: 100%;
            border-top-color: var(--primary);
            animation: weaveSpinRight 1s linear infinite;
        }

        .weave-thread-2 {
            width: 70%; height: 70%;
            border-left-color: #fff;
            border-width: 3px;
            animation: weaveSpinLeft 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            opacity: 0.8;
        }

        .weave-thread-3 {
            width: 140%; height: 140%;
            border-top-color: rgba(163, 255, 172, 0.4);
            border-right-color: rgba(163, 255, 172, 0.4);
            animation: weaveSpinRight 4s linear infinite;
        }

        .weave-core {
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 30px 10px var(--primary);
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes weaveSpinRight { 100% { transform: rotate(360deg); } }
        @keyframes weaveSpinLeft { 100% { transform: rotate(-360deg); } }
        @keyframes heartbeat {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.8); opacity: 1; box-shadow: 0 0 50px 15px var(--primary); }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .loading-label {
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-size: 0.75rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-align: center;
            animation: fadeIO 2s infinite;
        }

        @keyframes fadeIO {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* ========== TAB BAR (Floating Glass Pill) ========== */
        .tab-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            padding: 14px 32px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 50;
        }

        .tab-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            padding: 4px 16px;
            background: none;
            border: none;
            font-family: inherit;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .tab-bar-item svg { width: 22px; height: 22px; color: var(--text-muted); }
        .tab-bar-item span { font-size: 0.65rem; color: var(--text-muted); font-weight: 500; }
        .tab-bar-item.active { opacity: 1; }
        .tab-bar-item.active svg { color: var(--primary); }
        .tab-bar-item.active span { color: var(--primary); }

        /* ========== MODALS ========== */
        .modal-bg {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
        }
        .modal-bg.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 28px;
            width: 100%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            color: var(--text-main);
        }

        .modal-head {
            font-family: 'Merriweather', serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 18px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 0.9rem;
            font-family: inherit;
            margin-bottom: 8px;
        }
        .modal-input:focus { outline: none; border-color: var(--primary); }
        .modal-input::placeholder { color: var(--text-muted); }

        .modal-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
            display: block;
        }

        .modal-btns { display: flex; gap: 10px; margin-top: 18px; }
        .modal-btn {
            flex: 1;
            padding: 13px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }
        .modal-btn.cancel {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
        }
        .modal-btn.confirm {
            background: var(--primary);
            border: none;
            color: var(--bg-deep);
        }
        .modal-btn.confirm:hover { opacity: 0.9; }

        /* Delete modal */
        .delete-modal-icon {
            text-align: center;
            margin-bottom: 10px;
        }
        .delete-modal-msg {
            font-size: 0.82rem;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .delete-confirm-btn {
            background: #ff6b6b !important;
            color: white !important;
        }
        .delete-confirm-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Choice modal - slide-up decision sheet */
        .choice-confirm {
            align-items: flex-end;
            padding: 0;
        }
        .choice-confirm .modal {
            max-width: 100%;
            border-radius: 24px 24px 0 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: none;
            border-top: 1px solid var(--glass-border);
            padding: 28px 24px 36px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            position: relative;
        }

        .choice-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .choice-number {
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        .choice-number::before { content: 'Option '; }

        .choice-text {
            font-family: 'Merriweather', serif;
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 24px;
            color: rgba(255,255,255,0.85);
            text-align: left;
        }

        .choice-confirm .modal-btn.cancel {
            border-color: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.4);
        }
        .choice-confirm .modal-btn.confirm {
            background: var(--primary);
            color: var(--bg-deep);
        }
    </style>
</head>
<body>
    <div class="app" id="app">

        <!-- ========== HOME / LIBRARY SCREEN ========== -->
        <div id="homeScreen" class="screen active">
            <div class="home">
                <div class="home-header">
                    <div class="brand-logo">Rabbithole.</div>
                    <div class="nvidia-badge">
                        <svg viewBox="0 0 24 24" fill="#a3ffac"><path d="M8.948 8.798v-1.43a6.7 6.7 0 0 1 .424-.018c3.922-.124 6.058 3.277 6.058 3.277s-2.467 3.752-5.066 3.752c-.524 0-1.006-.1-1.416-.29V10.87c1.872.228 2.245 1.251 3.403 3.199l2.125-1.72s-1.605-2.388-4.03-2.388c-.555 0-1.065.082-1.498.237zm0-4.075V6.12a7.4 7.4 0 0 1 .424-.013c5.344-.166 8.353 4.46 8.353 4.46s-3.44 5.1-7.02 5.1a5.8 5.8 0 0 1-1.757-.275v-1.222c.524.174 1.088.268 1.686.268 2.87 0 4.925-2.606 4.925-2.606s-1.68-2.883-4.88-2.883c-.592 0-1.16.083-1.73.254zm0-3.03v1.724l-.425.142V2h5.654S10.882.282 8.948.382v1.31zm-1.48 9.066V2.281L5.973 3.204v9.543a7.97 7.97 0 0 0 1.494.012zm-1.494-.877V6.46S3.623 8.743 3.623 11.08c0 1.492.788 2.564.788 2.564l1.562-.762z"/></svg>
                        Powered by NVIDIA Nemotron
                    </div>
                </div>
                <div class="brand-tagline">The Infinite Interactive Audiobook</div>

                <div class="home-scroll">
                    <div class="section-head">
                        <div><span class="section-label">Your Library</span><span class="section-count" id="bookCount"></span></div>
                        <button class="search-toggle-btn" id="searchToggleBtn">
                            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" d="m21 21-4.35-4.35"/></svg>
                        </button>
                    </div>
                    <div class="search-bar" id="searchBar">
                        <svg class="search-bar-icon" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" d="m21 21-4.35-4.35"/></svg>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search books...">
                        <button class="search-clear" id="searchClear">&times;</button>
                    </div>
                    <div class="book-grid" id="bookGrid"></div>

                    <div class="section-head" id="allBooksHead" style="display:none">
                        <span class="section-label">All Books</span>
                    </div>
                    <div class="book-list" id="bookList"></div>
                </div>

            </div>
        </div>

        <!-- ========== UPLOAD SCREEN ========== -->
        <div id="uploadScreen" class="screen">
            <div class="upload-screen-content">
                <div class="upload-header">
                    <div class="brand-logo">Rabbithole.</div>
                    <div class="nvidia-badge">
                        <svg width="16" height="12" viewBox="0 0 24 18" fill="currentColor"><path d="M8.74.01S4.43.46 1.12 4.54c0 0-2.24 3.85-.28 9.84 0 0 1.23 3.13 4.08 3.6 0 0-1.23-2.1-1.32-4.31 0 0-.2-3.14 2.48-5.79 0 0 1.87-2.07 4.24-2.07l.06-1.75S8.74.01 8.74.01zM9.14 3.87v1.27s-2.9.45-4.32 3.17c0 0-1.67 2.85.06 5.93 0 0-2.3-1.1-2.61-4.32 0 0-.47-3.87 4.43-5.77l2.44-.28zm.12 2.14v1.02s-1.7.1-2.88 1.46c0 0-1.46 1.47-.78 3.42 0 0-.67-.7-.67-2.13 0 0-.2-2.56 4.33-3.77zm.06 2.03v3.53s-.1.77-.72 1.11l-.86.49s.64-1 .44-2.08c0 0-.12-1.07-1.56-2.04 0 0 1.2-.87 2.7-1.01zM12.06.01s4.31.45 7.62 4.53c0 0 2.24 3.85.28 9.84 0 0-1.23 3.13-4.08 3.6 0 0 1.23-2.1 1.32-4.31 0 0 .2-3.14-2.48-5.79 0 0-1.87-2.07-4.24-2.07l-.06-1.75s1.64-.05 1.64-.05zm-.4 3.86v1.27s2.9.45 4.32 3.17c0 0 1.67 2.85-.06 5.93 0 0 2.3-1.1 2.61-4.32 0 0 .47-3.87-4.43-5.77l-2.44-.28zm-.12 2.14v1.02s1.7.1 2.88 1.46c0 0 1.46 1.47.78 3.42 0 0 .67-.7.67-2.13 0 0 .2-2.56-4.33-3.77zm-.06 2.03v3.53s.1.77.72 1.11l.86.49s-.64-1-.44-2.08c0 0 .12-1.07 1.56-2.04 0 0-1.2-.87-2.7-1.01z"/></svg>
                        Powered by NVIDIA Nemotron
                    </div>
                </div>
                <div class="brand-tagline">The Infinite Interactive Audiobook</div>

                <div class="upload-drop-zone" id="uploadDropZone">
                    <div class="upload-drop-icon">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="3" x2="12" y2="15" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="upload-drop-title" id="uploadDropTitle">Tap to Upload</div>
                    <div class="upload-drop-desc" id="uploadDropDesc">Supports PDF and TXT from any source</div>
                </div>

                <div class="upload-steps">
                    <div class="upload-steps-label">How it works</div>
                    <div class="upload-step">
                        <div class="upload-step-num">1</div>
                        <div class="upload-step-text">
                            <strong>Upload your book</strong>
                            <span>Drop in any PDF or TXT file  novels, short stories, anything goes.</span>
                        </div>
                    </div>
                    <div class="upload-step">
                        <div class="upload-step-num">2</div>
                        <div class="upload-step-text">
                            <strong>We prepare your adventure</strong>
                            <span>NVIDIA Nemotron reads, understands and transforms your text into an interactive world.</span>
                        </div>
                    </div>
                    <div class="upload-step">
                        <div class="upload-step-num">3</div>
                        <div class="upload-step-text">
                            <strong>Enjoy the ride</strong>
                            <span>Listen, make choices, and shape the story. No two adventures are ever the same.</span>
                        </div>
                    </div>
                </div>

                <button class="upload-main-btn" id="uploadMainBtn" disabled>
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Generate Rabbithole
                </button>

                <div class="upload-overlay" id="uploadOverlay">
                    <div class="scanner-stage">
                        <div class="radar-ring ring-1"></div>
                        <div class="radar-ring ring-2"></div>
                        <div class="radar-ring ring-3"></div>
                        <div class="scanner-book">
                            <div class="scanner-laser"></div>
                            <div class="scanner-book-icon"></div>
                        </div>
                    </div>
                    <div class="upload-status-container">
                        <div class="upload-status-title">Ingesting Story</div>
                        <div class="upload-status" id="progressText">Initializing scanner...</div>
                        <div class="upload-bar">
                            <div class="upload-bar-fill" id="progressBarFill"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== BOOK DETAIL SCREEN ========== -->
        <div id="detailScreen" class="screen">
            <div class="detail">
                <div class="detail-ambient"></div>
                <div class="detail-header">
                    <button class="detail-back" id="detailBackBtn">
                        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="detail-header-brand">Rabbithole.</div>
                    <button class="detail-share-btn" id="detailShareBtn">
                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                    </button>
                </div>

                <div class="detail-scroll">
                    <div class="detail-cover-area">
                        <div class="detail-cover" id="detailCover">
                            <div class="detail-cover-inner" id="detailCoverInner">
                                <div class="detail-cover-title" id="detailCoverTitle">Book Title</div>
                                <div class="detail-cover-author" id="detailCoverAuthor">Author</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-title" id="detailTitle">Book Title</div>
                    <div class="detail-author-name" id="detailAuthor">
                        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                        Author Name
                    </div>

                    <div class="detail-buttons">
                        <button class="detail-play-btn" id="detailPlayBtn">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            Start Adventure
                        </button>
                    </div>

                    <div class="detail-info-sheet">
                        <div class="detail-overview">
                            <div class="detail-overview-title">Story Synopsis</div>
                            <div class="detail-overview-text" id="detailOverview">
                                Upload a book and let NVIDIA Nemotron create an interactive audio adventure. Each section becomes a branching narrative where your choices shape the story.
                            </div>
                        </div>

                        <div class="detail-tags" id="detailTags"></div>
                    </div>
                </div>

                <div class="detail-bottom-actions">
                    <button class="detail-bottom-btn" id="detailEditBtn">
                        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        Edit
                    </button>
                    <button class="detail-bottom-btn danger" id="detailDeleteBtn">
                        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== READER SCREEN ========== -->
        <div id="readerScreen" class="screen">
            <div class="reader-header">
                <button class="reader-back" id="backBtn">
                    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="reader-header-title">Rabbithole</div>
                <button class="reader-header-btn" id="shareBtn">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                </button>
            </div>

            <div class="model-bar">
                <div class="model-tag">
                    <span class="model-dot"></span>
                    <span class="model-label">LLM</span>
                    <span>Nemotron 30B</span>
                </div>
                <div class="model-tag">
                    <span class="model-dot"></span>
                    <span class="model-label">EMB</span>
                    <span>NV-EmbedQA</span>
                </div>
            </div>

            <div class="story-area">
                <div class="story-text-wrapper">
                    <div class="story-text" id="storyText"></div>
                </div>
            </div>

            <div class="player">
                <div class="player-book">
                    <div class="player-book-cover" id="playerCover">
                        <div class="player-book-cover-inner" id="playerCoverInner">
                            <span></span>
                        </div>
                    </div>
                    <div class="player-book-info">
                        <div class="player-book-title" id="playerTitle">Book Title</div>
                        <div class="player-book-author" id="playerAuthor">Interactive Adventure</div>
                    </div>
                    <div class="player-chapter-info" id="playerChapter">Section 1 / 1</div>
                </div>

                <div class="progress-area">
                    <div class="progress" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-row">
                        <span class="time-label" id="currentTime">0:00</span>
                        <span class="time-label" id="duration">0:00</span>
                    </div>
                </div>

                <div class="choices" id="choiceIcons">
                    <button class="choice-btn" data-choice="1" disabled>1</button>
                    <button class="choice-btn" data-choice="2" disabled>2</button>
                    <button class="choice-btn" data-choice="3" disabled>3</button>
                </div>

                <div class="controls">
                    <button class="ctrl-btn" id="rewindBtn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/></svg>
                    </button>
                    <button class="ctrl-btn play-btn" id="playPauseBtn">
                        <svg id="playIcon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pauseIcon" fill="currentColor" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <button class="ctrl-btn" id="forwardBtn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"/></svg>
                    </button>
                </div>
            </div>

            <div class="loading" id="loadingOverlay">
                <div class="weave-container">
                    <div class="weave-thread weave-thread-1"></div>
                    <div class="weave-thread weave-thread-2"></div>
                    <div class="weave-thread weave-thread-3"></div>
                    <div class="weave-core"></div>
                </div>
                <div class="loading-label" id="loadingLabel">Initializing Nemotron Engine...</div>
            </div>
        </div>

        <!-- Bottom tab bar (shared between Home & Upload) -->
        <div class="tab-bar" id="mainTabBar">
            <button class="tab-bar-item active" id="homeTabBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>Home</span>
            </button>
            <button class="tab-bar-item" id="uploadTabBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Upload</span>
            </button>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt">

        <!-- Choice Modal (Slide-up Decision Sheet) -->
        <div class="modal-bg choice-confirm" id="choiceModal">
            <div class="modal">
                <button class="choice-close" onclick="closeChoiceModal()">&times;</button>
                <div class="choice-number" id="choiceModalNumber">1</div>
                <div class="choice-text" id="choiceModalText">Choice text</div>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="closeChoiceModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmChoice()">Confirm Choice</button>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal-bg" id="editModal">
            <div class="modal">
                <div class="modal-head">Edit Book</div>
                <input type="hidden" id="editBookId">
                <label class="modal-label">Title</label>
                <input type="text" class="modal-input" id="editTitle" placeholder="Book title">
                <label class="modal-label">Author</label>
                <input type="text" class="modal-input" id="editAuthor" placeholder="Author name">
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="closeEditModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="saveBookEdit()">Save</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal-bg" id="deleteModal">
            <div class="modal">
                <div class="delete-modal-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="#ff6b6b" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>
                </div>
                <div class="modal-head">Delete this book?</div>
                <div class="delete-modal-msg" id="deleteModalMsg">This will permanently remove the book and all its data. This action cannot be undone.</div>
                <label class="modal-label">Type DELETE to confirm</label>
                <input type="text" class="modal-input" id="deleteConfirmInput" placeholder="DELETE" autocomplete="off" spellcheck="false">
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="closeDeleteModal()">Cancel</button>
                    <button class="modal-btn confirm delete-confirm-btn" id="deleteConfirmBtn" onclick="confirmDelete()" disabled>Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let sessionId = null;
        let currentSection = 1;
        let totalSections = 1;
        let bookTitle = '';
        let bookAuthor = '';
        let currentBookId = null;
        let currentBookGradient = '';
        let currentBookCover = null;
        let isPlaying = false;
        let isSpeaking = false;
        let currentAudio = null;
        let progressInterval = null;
        let currentTimeVal = 0;
        let estimatedDuration = 10;
        let currentChoices = [];
        let selectedChoiceIndex = null;
        let storyLines = [];
        let currentLineIndex = 0;
        let lineTimings = [];

        // ============ ELEMENTS ============
        const homeScreen = document.getElementById('homeScreen');
        const uploadScreen = document.getElementById('uploadScreen');
        const detailScreen = document.getElementById('detailScreen');
        const readerScreen = document.getElementById('readerScreen');
        const uploadOverlay = document.getElementById('uploadOverlay');
        const scannerBookIcon = document.querySelector('.scanner-book-icon');
        const progressText = document.getElementById('progressText');
        const progressBarFill = document.getElementById('progressBarFill');
        const uploadStatusTitle = document.querySelector('.upload-status-title');
        const fileInput = document.getElementById('fileInput');

        // Upload scanner cycling messages (from animation)
        const uploadMessages = [
            "Parsing PDF structure...",
            "Identifying protagonist...",
            "Mapping villain motives...",
            "Detecting plot twists...",
            "Analyzing narrative arcs...",
            "Scanning chapter boundaries..."
        ];
        let uploadMsgIdx = 0;
        let uploadMsgInterval = null;

        function startUploadCycler() {
            uploadMsgIdx = 0;
            progressText.textContent = 'Initializing scanner...';
            uploadMsgInterval = setInterval(() => {
                progressText.textContent = uploadMessages[uploadMsgIdx];
                uploadMsgIdx = (uploadMsgIdx + 1) % uploadMessages.length;
            }, 2000);
        }
        function stopUploadCycler() {
            if (uploadMsgInterval) { clearInterval(uploadMsgInterval); uploadMsgInterval = null; }
        }
        const bookGrid = document.getElementById('bookGrid');
        const bookList = document.getElementById('bookList');
        const backBtn = document.getElementById('backBtn');
        const playerTitle = document.getElementById('playerTitle');
        const playerChapter = document.getElementById('playerChapter');
        const storyText = document.getElementById('storyText');
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const choiceIcons = document.getElementById('choiceIcons');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingLabel = document.getElementById('loadingLabel');
        const editModal = document.getElementById('editModal');
        const choiceModal = document.getElementById('choiceModal');

        // Loading text cycler
        const loadingPhrases = [
            "Querying NeMo Embeddings...",
            "Retrieving Story Context...",
            "Fracturing Timeline...",
            "Calculating Survival Odds...",
            "Generating 3 Possible Futures...",
            "Synthesizing Narrative Path..."
        ];
        let loadingTextIdx = 0;
        let loadingTextInterval = null;

        function startLoadingText() {
            loadingTextIdx = 0;
            loadingLabel.textContent = 'Initializing Nemotron Engine...';
            loadingTextInterval = setInterval(() => {
                loadingLabel.textContent = loadingPhrases[loadingTextIdx];
                loadingTextIdx = (loadingTextIdx + 1) % loadingPhrases.length;
            }, 1800);
        }
        function stopLoadingText() {
            if (loadingTextInterval) { clearInterval(loadingTextInterval); loadingTextInterval = null; }
        }

        // ============ TAB NAVIGATION ============
        const mainTabBar = document.getElementById('mainTabBar');
        const tabBtns = document.querySelectorAll('.tab-bar-item');
        document.getElementById('homeTabBtn').addEventListener('click', () => switchTab('home'));
        document.getElementById('uploadTabBtn').addEventListener('click', () => switchTab('upload'));

        function switchTab(tab) {
            homeScreen.classList.remove('active');
            uploadScreen.classList.remove('active');
            detailScreen.classList.remove('active');
            readerScreen.classList.remove('active');
            tabBtns.forEach(b => b.classList.remove('active'));
            mainTabBar.style.display = 'flex';
            if (tab === 'home') {
                homeScreen.classList.add('active');
                document.getElementById('homeTabBtn').classList.add('active');
            } else if (tab === 'upload') {
                uploadScreen.classList.add('active');
                document.getElementById('uploadTabBtn').classList.add('active');
            }
        }

        function hideTabBar() { mainTabBar.style.display = 'none'; }

        // ============ UPLOAD ============
        let pendingFile = null;
        const uploadDropZone = document.getElementById('uploadDropZone');
        const uploadDropTitle = document.getElementById('uploadDropTitle');
        const uploadDropDesc = document.getElementById('uploadDropDesc');
        const uploadMainBtn = document.getElementById('uploadMainBtn');

        // Drop zone click  open file picker
        uploadDropZone.addEventListener('click', () => fileInput.click());

        // Drag & drop
        uploadDropZone.addEventListener('dragover', e => { e.preventDefault(); uploadDropZone.classList.add('drag-over'); });
        uploadDropZone.addEventListener('dragleave', () => uploadDropZone.classList.remove('drag-over'));
        uploadDropZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadDropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) selectFile(e.dataTransfer.files[0]);
        });

        // File selected via picker
        fileInput.addEventListener('change', e => { if (e.target.files.length) selectFile(e.target.files[0]); });

        function selectFile(file) {
            if (!file.name.match(/\.(pdf|txt)$/i)) { alert('PDF or TXT only'); return; }
            pendingFile = file;
            uploadDropZone.classList.add('has-file');
            uploadDropTitle.textContent = file.name;
            uploadDropDesc.textContent = (file.size / 1024 / 1024).toFixed(1) + ' MB  Tap to change';
            uploadMainBtn.disabled = false;
        }

        // Button triggers the actual upload
        uploadMainBtn.addEventListener('click', () => { if (pendingFile) handleFile(pendingFile); });

        async function handleFile(file) {
            if (!file.name.match(/\.(pdf|txt)$/i)) { alert('PDF or TXT only'); return; }
            uploadOverlay.classList.add('active');
            startUploadCycler();
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            if (data.icon && scannerBookIcon) scannerBookIcon.textContent = data.icon;
                            if (data.message) { stopUploadCycler(); progressText.textContent = data.message; }
                            if (data.progress !== undefined) progressBarFill.style.width = data.progress + '%';
                            if (data.stage === 'complete' && data.success) {
                                sessionId = data.session_id;
                                totalSections = data.total_chunks;
                                bookTitle = data.title;
                                bookAuthor = data.author || '';
                                currentBookGradient = gradients[0];
                                await new Promise(r => setTimeout(r, 600));
                                startReader();
                            }
                            if (data.stage === 'error') throw new Error(data.message);
                        } catch (e) { console.warn(e); }
                    }
                }
            } catch (error) {
                stopUploadCycler();
                if (scannerBookIcon) scannerBookIcon.textContent = '';
                progressText.textContent = error.message || 'Upload failed';
                setTimeout(resetUpload, 3000);
            }
        }

        function resetUpload() {
            uploadOverlay.classList.remove('active');
            progressBarFill.style.width = '0%';
            progressText.textContent = 'Initializing scanner...';
            if (scannerBookIcon) scannerBookIcon.textContent = '';
            pendingFile = null;
            uploadDropZone.classList.remove('has-file');
            uploadDropTitle.textContent = 'Tap to Upload';
            uploadDropDesc.textContent = 'Supports PDF and TXT from any source';
            uploadMainBtn.disabled = true;
            fileInput.value = '';
        }

        // ============ LIBRARY ============
        async function loadLibrary() {
            try {
                const res = await fetch('/api/books');
                const data = await res.json();
                renderLibrary(data.books || []);
            } catch (e) { console.error(e); }
        }

        const gradients = [
            'linear-gradient(145deg, #4a7a00 0%, #2d5500 50%, #1a3300 100%)',
            'linear-gradient(145deg, #3d6b00 0%, #2a4a00 50%, #1a2e00 100%)',
            'linear-gradient(145deg, #5a8a10 0%, #3d6500 50%, #1e3300 100%)',
            'linear-gradient(145deg, #2d6b2d 0%, #1a4a1a 50%, #0a2e0a 100%)',
            'linear-gradient(145deg, #6b8a00 0%, #4a6500 50%, #2e3d00 100%)',
            'linear-gradient(145deg, #3a5a0a 0%, #2a4500 50%, #1a2800 100%)',
            'linear-gradient(145deg, #4a8a2a 0%, #336b1a 50%, #1a4008 100%)',
            'linear-gradient(145deg, #5a7a20 0%, #3d5510 50%, #223308 100%)',
        ];

        let allBooks = [];

        function renderLibrary(books) {
            allBooks = books;
            renderBookList(books);
        }

        function renderBookList(books) {
            const countEl = document.getElementById('bookCount');
            countEl.textContent = books.length > 0 ? `${books.length} Books` : '';

            if (books.length === 0 && allBooks.length === 0) {
                bookGrid.innerHTML = `<div class="empty" style="grid-column: 1/-1"><div class="empty-icon"></div><div class="empty-text">No books yet.<br>Tap + to upload your first adventure!</div></div>`;
                bookList.innerHTML = '';
                document.getElementById('allBooksHead').style.display = 'none';
                return;
            }

            if (books.length === 0) {
                bookGrid.innerHTML = `<div class="empty" style="grid-column: 1/-1"><div class="empty-icon"></div><div class="empty-text">No books match your search</div></div>`;
                bookList.innerHTML = '';
                document.getElementById('allBooksHead').style.display = 'none';
                return;
            }

            // Grid view (top books)
            bookGrid.innerHTML = books.slice(0, 6).map((book, i) => {
                const grad = gradients[i % gradients.length];
                const coverImg = book.cover_url ? `<img src="${book.cover_url}" alt="${esc(book.title)}" onerror="this.remove()">` : '';
                return `
                <div class="book-cell" onclick="openDetail('${book.id}', '${esc(book.title)}', '${esc(book.author || '')}', ${book.total_chunks}, '${grad}', ${book.cover_url ? `'${book.cover_url}'` : 'null'}, ${book.summary ? `'${esc(book.summary)}'` : 'null'}, ${book.tags ? `'${esc(book.tags)}'` : 'null'})">
                    <div class="book-cover" style="background: ${grad}">
                        ${coverImg}
                        ${!book.cover_url ? `<div class="book-cover-inner">
                            <div class="book-cover-title">${book.title}</div>
                            <div class="book-cover-author">${book.author || 'Unknown'}</div>
                        </div>` : ''}
                    </div>
                    <div class="book-name">${book.title}</div>
                    <div class="book-author">${book.author || 'Unknown'}</div>
                </div>`;
            }).join('');

            // List view (remaining books)
            if (books.length > 6) {
                document.getElementById('allBooksHead').style.display = 'flex';
                bookList.innerHTML = books.slice(6).map((book, i) => {
                    const gi = (i + 6) % gradients.length;
                    const rowCover = book.cover_url
                        ? `<img src="${book.cover_url}" alt="${esc(book.title)}" onerror="this.parentElement.innerHTML='<div class=\\'book-row-cover-inner\\' style=\\'background:${gradients[gi]};border-radius:6px\\'><span>${esc(book.title).substring(0,20)}</span></div>'">`
                        : `<div class="book-row-cover-inner" style="background: ${gradients[gi]}; border-radius: 6px;"><span>${book.title.substring(0, 20)}</span></div>`;
                    return `
                    <div class="book-row" onclick="openDetail('${book.id}', '${esc(book.title)}', '${esc(book.author || '')}', ${book.total_chunks}, '${gradients[gi]}', ${book.cover_url ? `'${book.cover_url}'` : 'null'}, ${book.summary ? `'${esc(book.summary)}'` : 'null'}, ${book.tags ? `'${esc(book.tags)}'` : 'null'})">
                        <div class="book-row-cover">${rowCover}</div>
                        <div class="book-row-info">
                            <div class="book-row-title">${book.title}</div>
                            <div class="book-row-meta">${book.author || 'Unknown'}</div>
                            <div class="book-row-stats"><span>${book.total_chunks} sections</span></div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                document.getElementById('allBooksHead').style.display = 'none';
                bookList.innerHTML = '';
            }
        }

        // Search
        const searchToggleBtn = document.getElementById('searchToggleBtn');
        const searchBar = document.getElementById('searchBar');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');

        searchToggleBtn.addEventListener('click', () => {
            const open = searchBar.classList.toggle('active');
            searchToggleBtn.classList.toggle('active', open);
            if (open) {
                searchInput.focus();
            } else {
                searchInput.value = '';
                searchClear.classList.remove('visible');
                renderBookList(allBooks);
            }
        });

        searchInput.addEventListener('input', () => {
            const q = searchInput.value.trim().toLowerCase();
            searchClear.classList.toggle('visible', q.length > 0);
            if (!q) { renderBookList(allBooks); return; }
            const filtered = allBooks.filter(b =>
                b.title.toLowerCase().includes(q) ||
                (b.author || '').toLowerCase().includes(q) ||
                (b.tags || '').toLowerCase().includes(q)
            );
            renderBookList(filtered);
        });

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchClear.classList.remove('visible');
            renderBookList(allBooks);
            searchInput.focus();
        });

        function esc(s) { return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

        // ============ BOOK DETAIL ============
        function openDetail(bookId, title, author, chunks, gradient, coverUrl, summary, tags) {
            currentBookId = bookId;
            bookTitle = title;
            bookAuthor = author;
            totalSections = chunks;
            currentBookGradient = gradient;
            currentBookCover = coverUrl || null;

            const detailCover = document.getElementById('detailCover');
            if (currentBookCover) {
                detailCover.innerHTML = `<img src="${currentBookCover}" alt="${title}" onerror="this.remove()">`;
            } else {
                detailCover.innerHTML = `<div class="detail-cover-inner" id="detailCoverInner" style="background: ${gradient}">
                    <div class="detail-cover-title" id="detailCoverTitle">${title}</div>
                    <div class="detail-cover-author" id="detailCoverAuthor">${author || 'Unknown'}</div>
                </div>`;
            }
            document.getElementById('detailTitle').textContent = title;
            document.getElementById('detailAuthor').innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;color:var(--accent)"><circle cx="12" cy="12" r="10"/></svg> ${author || 'Unknown'}`;
            document.getElementById('detailOverview').textContent = summary || 'Your choices shape the story. No two adventures are ever the same.';

            // Render tags
            let tagList = [];
            try { if (tags) tagList = JSON.parse(tags); } catch(e) {}
            const tagsEl = document.getElementById('detailTags');
            tagsEl.innerHTML = tagList.length > 0
                ? tagList.map(t => `<span class="detail-tag">${t}</span>`).join('')
                : '<span class="detail-tag">Interactive Fiction</span>';

            homeScreen.classList.remove('active');
            uploadScreen.classList.remove('active');
            detailScreen.classList.add('active');
            hideTabBar();
        }

        document.getElementById('detailBackBtn').addEventListener('click', () => {
            switchTab('home');
        });

        document.getElementById('detailShareBtn').addEventListener('click', async () => {
            const shareData = {
                title: bookTitle,
                text: `Check out "${bookTitle}" on Rabbithole  The Infinite Interactive Audiobook`,
                url: window.location.href
            };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch(e) {}
            } else {
                await navigator.clipboard.writeText(shareData.text + ' ' + shareData.url);
                alert('Link copied to clipboard!');
            }
        });

        document.getElementById('detailPlayBtn').addEventListener('click', async () => {
            try {
                const res = await fetch(`/api/books/${currentBookId}/start`, { method: 'POST' });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                sessionId = data.session_id;
                totalSections = data.total_chunks;
                bookTitle = data.title;
                detailScreen.classList.remove('active');
                startReader();
            } catch (e) { alert('Failed: ' + e.message); }
        });

        document.getElementById('detailEditBtn').addEventListener('click', () => {
            openEditModal(currentBookId, bookTitle, bookAuthor);
        });

        // ============ DELETE MODAL ============
        const deleteModal = document.getElementById('deleteModal');
        const deleteConfirmInput = document.getElementById('deleteConfirmInput');
        const deleteConfirmBtn = document.getElementById('deleteConfirmBtn');

        document.getElementById('detailDeleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModalMsg').textContent = `This will permanently remove "${bookTitle}" and all its data. This action cannot be undone.`;
            deleteConfirmInput.value = '';
            deleteConfirmBtn.disabled = true;
            deleteModal.classList.add('active');
            setTimeout(() => deleteConfirmInput.focus(), 100);
        });

        deleteConfirmInput.addEventListener('input', () => {
            deleteConfirmBtn.disabled = deleteConfirmInput.value.trim() !== 'DELETE';
        });

        function closeDeleteModal() {
            deleteModal.classList.remove('active');
            deleteConfirmInput.value = '';
            deleteConfirmBtn.disabled = true;
        }

        async function confirmDelete() {
            if (deleteConfirmInput.value.trim() !== 'DELETE') return;
            try {
                await fetch(`/api/books/${currentBookId}`, { method: 'DELETE' });
                closeDeleteModal();
                loadLibrary();
                switchTab('home');
            } catch (e) { alert(e.message); }
        }

        deleteModal.addEventListener('click', e => { if (e.target === deleteModal) closeDeleteModal(); });

        function openEditModal(bookId, title, author) {
            document.getElementById('editBookId').value = bookId;
            document.getElementById('editTitle').value = title;
            document.getElementById('editAuthor').value = author;
            editModal.classList.add('active');
        }
        function closeEditModal() { editModal.classList.remove('active'); }

        async function saveBookEdit() {
            const bookId = document.getElementById('editBookId').value;
            const title = document.getElementById('editTitle').value.trim();
            const author = document.getElementById('editAuthor').value.trim();
            if (!title) return;
            try {
                await fetch(`/api/books/${bookId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, author: author || null })
                });
                closeEditModal();
                // Update detail screen immediately
                bookTitle = title;
                bookAuthor = author;
                const coverTitleEl = document.getElementById('detailCoverTitle');
                if (coverTitleEl) coverTitleEl.textContent = title;
                const coverAuthorEl = document.getElementById('detailCoverAuthor');
                if (coverAuthorEl) coverAuthorEl.textContent = author || 'Unknown';
                document.getElementById('detailTitle').textContent = title;
                document.getElementById('detailAuthor').innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;color:var(--accent)"><circle cx="12" cy="12" r="10"/></svg> ${author || 'Unknown'}`;
                loadLibrary();
            } catch (e) { alert(e.message); }
        }

        // ============ READER ============
        function startReader() {
            homeScreen.classList.remove('active');
            uploadScreen.classList.remove('active');
            detailScreen.classList.remove('active');
            readerScreen.classList.add('active');
            hideTabBar();
            playerTitle.textContent = bookTitle;
            document.getElementById('playerAuthor').textContent = bookAuthor || 'Interactive Adventure';

            // Set player cover
            const playerCoverEl = document.getElementById('playerCover');
            if (currentBookCover) {
                playerCoverEl.innerHTML = `<img src="${currentBookCover}" alt="${bookTitle}">`;
            } else {
                playerCoverEl.innerHTML = `<div class="player-book-cover-inner" id="playerCoverInner" style="background: ${currentBookGradient}"><span>${bookTitle.substring(0, 15)}</span></div>`;
            }

            updateMeta();
            disableChoices();
            resetUpload();
            sendMessage(null, true);
        }

        function updateMeta() {
            playerChapter.textContent = `Section ${currentSection} / ${totalSections}`;
        }

        backBtn.addEventListener('click', () => {
            stopAudio();
            resetUpload();
            loadLibrary();
            switchTab('home');
        });

        document.getElementById('shareBtn').addEventListener('click', async () => {
            const shareData = {
                title: `${bookTitle} - Rabbithole`,
                text: `I'm on an interactive audio adventure through "${bookTitle}" on Rabbithole  The Infinite Interactive Audiobook, powered by NVIDIA Nemotron!`,
                url: window.location.href
            };
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
                    const btn = document.getElementById('shareBtn');
                    btn.style.color = 'var(--nvidia-green)';
                    setTimeout(() => btn.style.color = '', 1500);
                }
            } catch (e) { /* user cancelled */ }
        });

        async function sendMessage(userInput, isStart = false) {
            stopAudio();
            loadingOverlay.classList.add('active');
            startLoadingText();
            disableChoices();

            try {
                const response = await fetch('/api/adventure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, user_input: userInput })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Error');
                if (!data.response) throw new Error('No response');

                currentSection = data.current_section;
                totalSections = data.total_sections;
                updateMeta();
                displayStory(data.response);
            } catch (error) {
                storyText.innerHTML = '<span class="line current">Something went wrong. Try again.</span>';
                currentChoices = ['Try again', 'Go back', 'Restart'];
                enableChoices();
                stopLoadingText();
                loadingOverlay.classList.remove('active');
            }
        }

        function displayStory(text) {
            stopLoadingText();
            loadingOverlay.classList.remove('active');

            const choiceRegex = /(\d)[.)]\s*(.+?)(?=\n\d[.)]|\n*$)/gs;
            const matches = [...text.matchAll(choiceRegex)];
            let narrative = text;
            currentChoices = [];

            if (matches.length >= 2) {
                const firstIdx = text.search(/\d[.)]\s/);
                if (firstIdx > 0) narrative = text.substring(0, firstIdx).trim();
                matches.forEach((m, i) => { if (i < 3) currentChoices.push(m[2].trim()); });
            }
            // Always ensure exactly 3 choices
            const defaults = ['Continue forward', 'Look around', 'Go back'];
            while (currentChoices.length < 3) {
                currentChoices.push(defaults[currentChoices.length]);
            }

            storyLines = narrative.split(/(?<=[.!?])\s+/).filter(s => s.trim());
            currentLineIndex = 0;
            calculateLineTimings();
            renderStoryLines(true);
            enableChoices();

            estimatedDuration = Math.max(5, Math.ceil(narrative.split(' ').length / 2.5));
            durationEl.textContent = formatTime(estimatedDuration);
            currentTimeVal = 0;
            currentTimeEl.textContent = '0:00';
            progressFill.style.width = '0%';

            playAudio(narrative);
        }

        function renderStoryLines(initial = false) {
            storyText.innerHTML = storyLines.map((line, i) => {
                const diff = i - currentLineIndex;
                let cls = 'line';
                if (diff < 0) cls += ' passed';
                else if (diff === 0) cls += ' current';
                else {
                    cls += ' upcoming';
                    if (diff === 1) cls += ' upcoming-1';
                    else if (diff === 2) cls += ' upcoming-2';
                    else if (diff === 3) cls += ' upcoming-3';
                    else cls += ' upcoming-far';
                }
                return `<span class="${cls}" data-index="${i}">${line}</span>`;
            }).join('');

            if (initial) requestAnimationFrame(() => scrollToCurrent(false));
            else scrollToCurrent(true);
        }

        function scrollToCurrent(animate = true) {
            const wrapper = document.querySelector('.story-text-wrapper');
            const cur = storyText.querySelector('.line.current');
            if (!wrapper || !cur) return;
            const targetY = cur.offsetTop - (wrapper.clientHeight * 0.35) + (cur.offsetHeight / 2);
            storyText.style.transition = animate ? 'transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)' : 'none';
            storyText.style.transform = `translateY(-${Math.max(0, targetY)}px)`;
        }

        function calculateLineTimings() {
            const total = storyLines.reduce((s, l) => s + l.length, 0);
            lineTimings = [];
            let cum = 0;
            storyLines.forEach(line => {
                const w = line.length / total;
                lineTimings.push({ start: cum, end: cum + w });
                cum += w;
            });
        }

        function updateCurrentLine(progress) {
            let idx = 0;
            for (let i = 0; i < lineTimings.length; i++) {
                if (progress >= lineTimings[i].start && progress < lineTimings[i].end) { idx = i; break; }
                if (progress >= lineTimings[i].end) idx = i + 1;
            }
            idx = Math.min(idx, storyLines.length - 1);
            if (idx !== currentLineIndex) {
                currentLineIndex = idx;
                storyText.querySelectorAll('.line').forEach((el, i) => {
                    const d = i - currentLineIndex;
                    el.className = 'line';
                    if (d < 0) el.classList.add('passed');
                    else if (d === 0) el.classList.add('current');
                    else {
                        el.classList.add('upcoming');
                        if (d === 1) el.classList.add('upcoming-1');
                        else if (d === 2) el.classList.add('upcoming-2');
                        else if (d === 3) el.classList.add('upcoming-3');
                        else el.classList.add('upcoming-far');
                    }
                });
                scrollToCurrent(true);
            }
        }

        // ============ CHOICES ============
        function enableChoices() {
            choiceIcons.querySelectorAll('.choice-btn').forEach((b, i) => b.disabled = i >= currentChoices.length);
        }
        function disableChoices() {
            choiceIcons.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
        }

        choiceIcons.addEventListener('click', e => {
            const btn = e.target.closest('.choice-btn');
            if (!btn || btn.disabled) return;
            selectedChoiceIndex = parseInt(btn.dataset.choice) - 1;
            if (currentChoices[selectedChoiceIndex]) {
                document.getElementById('choiceModalNumber').textContent = selectedChoiceIndex + 1;
                document.getElementById('choiceModalText').textContent = currentChoices[selectedChoiceIndex];
                choiceModal.classList.add('active');
            }
        });

        function closeChoiceModal() { choiceModal.classList.remove('active'); selectedChoiceIndex = null; }

        function confirmChoice() {
            if (selectedChoiceIndex !== null && currentChoices[selectedChoiceIndex]) {
                const text = `${selectedChoiceIndex + 1}. ${currentChoices[selectedChoiceIndex]}`;
                closeChoiceModal();
                sendMessage(text);
            }
        }

        // ============ AUDIO ============
        async function playAudio(text, voice = 'narrator') {
            stopAudio();
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voice })
                });
                if (!response.ok) throw new Error('TTS failed');
                const data = await response.json();
                if (!data.audio_data) throw new Error('No audio');

                const blob = base64ToBlob(data.audio_data, 'audio/mpeg');
                currentAudio = new Audio(URL.createObjectURL(blob));

                currentAudio.onloadedmetadata = () => {
                    estimatedDuration = currentAudio.duration || 10;
                    durationEl.textContent = formatTime(estimatedDuration);
                };
                currentAudio.onplay = () => { isPlaying = true; isSpeaking = true; updatePlayBtn(); startProgress(); };
                currentAudio.onended = () => {
                    isPlaying = false; isSpeaking = false; updatePlayBtn();
                    clearInterval(progressInterval);
                    progressFill.style.width = '100%';
                    currentLineIndex = storyLines.length - 1;
                    renderStoryLines();
                };
                currentAudio.onerror = () => { isPlaying = false; isSpeaking = false; updatePlayBtn(); };
                await currentAudio.play();
            } catch (e) { console.error('TTS:', e); }
        }

        function startProgress() {
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if (currentAudio && !currentAudio.paused) {
                    currentTimeVal = currentAudio.currentTime;
                    const dur = currentAudio.duration || estimatedDuration;
                    const p = currentTimeVal / dur;
                    progressFill.style.width = (p * 100) + '%';
                    currentTimeEl.textContent = formatTime(currentTimeVal);
                    updateCurrentLine(p);
                }
            }, 100);
        }

        function stopAudio() {
            if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
            isPlaying = false; isSpeaking = false; updatePlayBtn(); clearInterval(progressInterval);
        }

        function togglePlay() {
            if (currentAudio) {
                if (currentAudio.paused) { currentAudio.play(); isPlaying = true; startProgress(); }
                else { currentAudio.pause(); isPlaying = false; clearInterval(progressInterval); }
                updatePlayBtn();
            } else if (storyLines.length) playAudio(storyLines.join(' '));
        }

        function updatePlayBtn() {
            playIcon.style.display = isPlaying ? 'none' : 'block';
            pauseIcon.style.display = isPlaying ? 'block' : 'none';
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        playPauseBtn.addEventListener('click', togglePlay);

        function base64ToBlob(b64, mime) {
            const chars = atob(b64);
            const bytes = new Uint8Array(chars.length);
            for (let i = 0; i < chars.length; i++) bytes[i] = chars.charCodeAt(i);
            return new Blob([bytes], { type: mime });
        }

        // ============ INIT ============
        loadLibrary();
        editModal.addEventListener('click', e => { if (e.target === editModal) closeEditModal(); });
        choiceModal.addEventListener('click', e => { if (e.target === choiceModal) closeChoiceModal(); });
    </script>
</body>
</html>
